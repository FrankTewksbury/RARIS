# Session Journal — 2026-02-26 — Phases 8-11

## Session Summary

Continued from a prior session that had completed Phases 0-7 and written (but not
committed) Phase 8. This session committed Phase 8 and built Phases 9-11.

## Phases Delivered

### Phase 8: Auth, Scheduling & Observability (committed from prior session)
- API key auth (SHA-256 hashed, read/write/admin scopes, optional via `AUTH_ENABLED`)
- APScheduler with change monitor + accuracy snapshot cron jobs
- Request logging middleware with correlation IDs and response timing
- Deep health checks (DB + Redis readiness probe)
- Config validation on startup
- Admin endpoints (key CRUD, system info, scheduler status)
- 14 files, 1013 insertions → `2c5597a`

### Phase 9: Database Migrations, Rate Limiting & Gap Closure
- Alembic initial migration — all 21 tables, pgvector extension, HNSW/GIN indexes
- Redis sliding window rate limiter (60 req/min default, fail-open)
- Rate limit headers and 429 enforcement in middleware
- Frontend test coverage for all 6 pages
- 10 files, 935 insertions → `1682179`

### Phase 10: Scraper Rate, Export API, Embedding Cache & Frontend Resilience
- Per-domain `asyncio.sleep` rate enforcement in scraper
- Export endpoints (manifest JSON, query CSV, corpus summary)
- Redis-based embedding cache (24h TTL)
- React ErrorBoundary, NotFound 404 page
- LoadingSpinner, EmptyState reusable components
- API client: auth header injection, DELETE method, 429 retry-after
- 17 files, 610 insertions → `21445e9`

### Phase 11: Retrieval Quality, Docker Hardening & CI Improvements
- Batch LLM reranker (single prompt instead of N serial calls)
- precision@k and NDCG@k eval metrics
- API acquisition adapter (auth, pagination, replaces stub)
- Dockerfile HEALTHCHECK for both services
- docker-compose.prod.yml (secure defaults, no exposed DB/Redis)
- CI: test_health re-enabled, format check, build gated on tests
- CSS scaffold cleanup (removed conflicting Vite rules)
- 13 files, 513 insertions → `df02b34`

## Test Growth

| Phase | Backend Tests | Frontend Tests |
|-------|--------------|----------------|
| Phase 8 | 181 | 7 |
| Phase 9 | 189 (+8) | 14 (+7) |
| Phase 10 | 203 (+14) | 16 (+2) |
| Phase 11 | 230 (+27) | 16 |

## Key Fixes During Session

- `_parse_score` in reranker didn't handle bare integers from `json.loads` → added `isinstance` check
- CurationDashboard test mock had wrong hook name (`useIndexHealth` → `useIndexStats`)
- Ruff: removed unused imports (AsyncMock, Base), fixed import sorting, line-length violations
- index.css had conflicting Vite scaffold `body { display: flex; place-items: center }` → stripped

## Patterns Established

- All phases follow: spec doc → implementation → wiring → tests → ruff/tsc/eslint → commit
- Backend tests use in-memory SQLite with custom `@compiles` for JSONB/TSVECTOR
- Frontend tests mock hooks via `vi.mock`, wrap in QueryClient + MemoryRouter
- Commits use heredoc format with `Co-Authored-By: Claude Opus 4.6`
- Phase specs numbered sequentially: `00N-spec-phaseN-*.md`
