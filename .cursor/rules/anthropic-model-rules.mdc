---
description: Global Implementation Standards for Claude 4.x Series, Web Search, Extended Thinking, and Resilient RAG
alwaysApply: false
---
# Anthropic Claude Global Implementation Rules

> **MANDATORY:** Do not rely on pre-2025 training data regarding model IDs or SDK patterns. Always use the implementation patterns defined in this document for all Python-based Anthropic integrations.

---

## 1. Model Selection & Lifecycle

| Model ID | Tier | Use Case | Context | Max Output | Pricing (MTok) |
|----------|------|----------|---------|------------|----------------|
| `claude-opus-4-6` | Most Capable | **DEFAULT** - Complex agents, deep reasoning | 200K (1M beta) | 128K | $5 / $25 |
| `claude-sonnet-4-6` | Balanced | Speed + intelligence, general tasks | 200K (1M beta) | 64K | $3 / $15 |
| `claude-haiku-4-5` | Fastest | High-speed classification, extraction | 200K | 64K | $1 / $5 |

All models support: text input, image input, vision, extended thinking, multilingual.

### Task-Based Selection

| Task Type | Model | Notes |
|-----------|-------|-------|
| Discovery, complex agents | `claude-opus-4-6` | Highest accuracy, adaptive thinking |
| General tasks, balanced | `claude-sonnet-4-6` | Best speed/quality tradeoff |
| Classification, extraction | `claude-haiku-4-5` | Lowest cost, fastest |

### Deprecated Models (DO NOT USE)

* `claude-3-opus` / `claude-3-sonnet` / `claude-3-haiku`
* `claude-3.5-sonnet` / `claude-3.5-haiku`
* Any model without the `claude-{tier}-{major}-{minor}` naming pattern

---

## 2. Core API Implementation (Python SDK)

### 2.1 SDK Initialization

```python
import anthropic
import os

client = anthropic.Anthropic(api_key=os.getenv("ANTHROPIC_API_KEY"))
async_client = anthropic.AsyncAnthropic(api_key=os.getenv("ANTHROPIC_API_KEY"))
```

### 2.2 Messages API Pattern

Anthropic uses the Messages API (not Chat Completions). System messages are a top-level parameter, not part of the messages array.

```python
def call_claude(
    prompt: str,
    model: str = "claude-sonnet-4-6",
    system_prompt: str = None,
    max_tokens: int = 4096,
) -> str:
    params = {
        "model": model,
        "max_tokens": max_tokens,
        "messages": [{"role": "user", "content": prompt}],
    }
    if system_prompt:
        params["system"] = system_prompt

    response = client.messages.create(**params)
    return response.content[0].text
```

### 2.3 Async Pattern

```python
async def call_claude_async(
    prompt: str,
    model: str = "claude-sonnet-4-6",
    system_prompt: str = None,
    max_tokens: int = 4096,
) -> str:
    params = {
        "model": model,
        "max_tokens": max_tokens,
        "messages": [{"role": "user", "content": prompt}],
    }
    if system_prompt:
        params["system"] = system_prompt

    response = await async_client.messages.create(**params)
    return response.content[0].text
```

---

## 3. Web Search Tool

Claude provides a built-in web search tool (`web_search_20260209`) that enables live web access with automatic citations. No external search API key is required.

### 3.1 Basic Web Search

```python
response = client.messages.create(
    model="claude-sonnet-4-6",
    max_tokens=4096,
    messages=[{
        "role": "user",
        "content": "Find current down payment assistance programs in Texas"
    }],
    tools=[{
        "type": "web_search_20260209",
        "name": "web_search"
    }]
)
```

### 3.2 Dynamic Filtering (Opus 4.6 / Sonnet 4.6 Only)

Dynamic filtering lets Claude write and execute code to filter search results before they enter the context window — keeping only relevant content and reducing token consumption by ~24%.

Requires the code execution tool to be enabled alongside web search.

```python
response = client.messages.create(
    model="claude-opus-4-6",
    max_tokens=8192,
    messages=[{
        "role": "user",
        "content": "Research current CDFI down payment assistance programs and extract program names, eligibility, and amounts"
    }],
    tools=[
        {"type": "web_search_20260209", "name": "web_search"},
        {"type": "code_execution_20250522", "name": "code_execution"}
    ]
)
```

### 3.3 When to Use Web Search

| Use Case | Web Search? | Rationale |
|----------|------------|-----------|
| Discovery — finding entities, URLs, programs | **YES** | Gets current data, prevents hallucinated URLs |
| Verification — confirming a URL or program exists | **YES** | Live web check with citations |
| Technical research, literature review | **YES** | Dynamic filtering excels here |
| Classification — categorizing already-retrieved text | No | Input is already grounded |
| JSON extraction — parsing structured data from text | No | Deterministic task, search adds latency |

### 3.4 Supported Models for Web Search

All current models: Opus 4.6, Sonnet 4.6, Sonnet 4.5, Sonnet 4, Opus 4.5, Opus 4.1, Opus 4, Haiku 4.5. Dynamic filtering requires Opus 4.6 or Sonnet 4.6.

---

## 4. Extended Thinking

Extended thinking lets Claude show its reasoning process. Available on all current models.

### 4.1 Standard Thinking (Sonnet, Haiku)

```python
response = client.messages.create(
    model="claude-sonnet-4-6",
    max_tokens=16000,
    thinking={"type": "enabled", "budget_tokens": 10000},
    messages=[{"role": "user", "content": "Analyze this regulatory document..."}],
)

for block in response.content:
    if block.type == "thinking":
        print(f"Thinking: {block.thinking}")
    elif block.type == "text":
        print(f"Response: {block.text}")
```

### 4.2 Adaptive Thinking (Opus 4.6 Only)

Opus 4.6 supports adaptive thinking where the model dynamically allocates its reasoning budget.

```python
response = client.messages.create(
    model="claude-opus-4-6",
    max_tokens=16000,
    thinking={"type": "adaptive"},
    messages=[{"role": "user", "content": "Complex multi-step analysis..."}],
)
```

---

## 5. Structured Outputs

### 5.1 JSON Output Mode

Use `output_config.format` to constrain responses to a JSON schema. Uses constrained decoding — the model cannot generate tokens that violate the schema.

```python
response = client.messages.create(
    model="claude-sonnet-4-6",
    max_tokens=4096,
    messages=[{"role": "user", "content": "Extract entities from this text..."}],
    output_config={
        "format": {
            "type": "json_schema",
            "json_schema": {
                "type": "object",
                "properties": {
                    "entities": {"type": "array", "items": {"type": "string"}},
                    "analysis": {"type": "string"}
                },
                "required": ["entities", "analysis"]
            }
        }
    }
)
```

Supported on: Opus 4.6, Sonnet 4.6, Sonnet 4.5, Opus 4.5, Haiku 4.5.

---

## 6. Error Handling & Resilience

### 6.1 Exception Types

```python
from anthropic import (
    APIConnectionError,
    RateLimitError,
    AuthenticationError,
    PermissionDeniedError,
    BadRequestError,
    NotFoundError,
    APIStatusError,
    InternalServerError,
)
```

### 6.2 Retry Policy

| Exception | HTTP Code | Action |
|-----------|-----------|--------|
| `RateLimitError` | 429 | Retry with backoff, respect `retry-after` header |
| `InternalServerError` | 500+ | Retry with backoff |
| `APIConnectionError` | N/A | Retry with backoff |
| `AuthenticationError` | 401 | **Fail fast** |
| `PermissionDeniedError` | 403 | **Fail fast** |
| `BadRequestError` | 400 | **Fail fast** |
| `NotFoundError` | 404 | **Fail fast** |

### 6.3 Resilient Pattern

```python
import time
from anthropic import (
    RateLimitError, APIConnectionError, InternalServerError,
    AuthenticationError, BadRequestError, PermissionDeniedError, NotFoundError
)

FAIL_FAST = (AuthenticationError, BadRequestError, PermissionDeniedError, NotFoundError)

def call_with_retry(func, max_retries: int = 3):
    for attempt in range(max_retries):
        try:
            return func()
        except FAIL_FAST:
            raise
        except RateLimitError as e:
            retry_after = getattr(e, "response", None)
            if retry_after and hasattr(retry_after, "headers"):
                wait = int(retry_after.headers.get("retry-after", 2 ** attempt))
            else:
                wait = 2 ** attempt
            time.sleep(wait)
        except (InternalServerError, APIConnectionError):
            time.sleep(2 ** attempt)
    raise RuntimeError(f"All {max_retries} retry attempts failed")
```

---

## 7. Quick Reference

### Environment Variables

```
ANTHROPIC_API_KEY=your_api_key_here
ANTHROPIC_MODEL=claude-sonnet-4-6
```

### Minimal Working Example

```python
import os
import anthropic

client = anthropic.Anthropic(api_key=os.getenv("ANTHROPIC_API_KEY"))

response = client.messages.create(
    model="claude-sonnet-4-6",
    max_tokens=4096,
    messages=[{"role": "user", "content": "Analyze this document..."}],
    tools=[{"type": "web_search_20260209", "name": "web_search"}]
)

for block in response.content:
    if block.type == "text":
        print(block.text)
```
